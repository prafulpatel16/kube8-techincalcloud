#replicaset Deployments

In replicaset it can create multiple labels pods at the same time which is not in replication-controller

Replicaset does not support rolling update which is disadvantage which resolves by the Deployments

root@master-node-ubuntu:~# kubectl get pod --show-labels
NAME                READY   STATUS    RESTARTS   AGE    LABELS
prafulcloud-692hb   1/1     Running   0          105s   team=dev
prafulcloud-6cl25   1/1     Running   0          105s   team=dev
prafulcloud-dxgfk   1/1     Running   0          105s   team=dev

Above pods are running from replication controller yaml, now we have to deploy with replicaset
and in replicaset it can be defined multiple labels and system will acquire all the pods which matches the pods defined in 'matchexpressions
section' like -dev, -prod, -test


Create a two new pod with label dev and prod

kubectl run dev --image=nginx 

kubectl run prod --image=nginx

root@master-node-ubuntu:~# kubectl get pod --show-labels
NAME   READY   STATUS              RESTARTS   AGE    LABELS
dev    0/1     ContainerCreating   0          114s   run=dev
prod   0/1     ContainerCreating   0          100s   run=prod

remove the default lable run-

root@master-node-ubuntu:~# kubectl label pod dev run-
pod/dev labeled
root@master-node-ubuntu:~# kubectl label pod prod run-
pod/prod labeled

Now labels are set to None
root@master-node-ubuntu:~# kubectl get pod --show-labels
NAME   READY   STATUS              RESTARTS   AGE     LABELS
dev    0/1     ContainerCreating   0          5m29s   <none>
prod   0/1     ContainerCreating   0          5m15s   <none>

Now assign new labels 

root@master-node-ubuntu:~# kubectl label pod dev team=dev
pod/dev labeled
root@master-node-ubuntu:~# kubectl label pod prod team=prod
pod/prod labeled
root@master-node-ubuntu:~# kubectl get pods --show-labels
NAME   READY   STATUS              RESTARTS   AGE     LABELS
dev    0/1     ContainerCreating   0          7m23s   team=dev
prod   0/1     ContainerCreating   0          7m9s    team=prod

Now deploy replicaset and see if there are any pod with the name dev and prod and test is exists and they are no member of any other
replicaset then it will acquire those pods and will not create new pods from the desired replicas capacity.

now lets deploy replicaset and see it will only create 2 new pods since there are already one dev pod is exist in the system

apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: prafulcloud
spec:
  replicas: 3
  selector:
    matchExpressions:
      - key: team
        operator: In
        values:
          - dev
          - prod
          - test
    team: dev
  template:
    metadata:
      name: prafulcloud
      labels:
        team: dev
    spec:
      containers:
        - name: prafulcloud
          image: nginx:1.9.1
          ports:
            - containerPort: 80

when deploy this ReplicaSet it will create 2 new dev and 2 new prod 

NAME                    READY   STATUS    RESTARTS   AGE     LABELS
pod/dev                 1/1     Running   0          3m13s   team=dev
pod/prafulcloud-t9f6j   1/1     Running   0          50s     team=dev
pod/prod                1/1     Running   0          3m1s    team=prod
NAME                          DESIRED   CURRENT   READY   AGE   LABELS
replicaset.apps/prafulcloud   3         3         3       50s   <none>

- Replicaset feature Operator: NotIn 

apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: prafulcloud
spec:
  replicas: 3
  selector:
    matchExpressions:
      - key: team
        operator: In
        values:
          - dev
          - prod
          - test
      - key: team
        operator: NotIn
        values:
          - test
  template:
      metadata:
        name: prafulcloud
        labels:
          team: dev
      spec:
        containers:
        - name: prafulcloud
          image: nginx:1.9.1
          ports:
            - containerPort: 80


-Create 3 pods to prove the NotIn 

kubectl run dev --image=nginx

kubectl run prod --image=nginx

kubectl run test --image=nginx

NAME       READY   STATUS    RESTARTS   AGE   LABELS
pod/dev    1/1     Running   0          35s   run=dev
pod/prod   1/1     Running   0          25s   run=prod
pod/test   1/1     Running   0          11s   run=test


Chnage the labels to team=dev, team=prod, team=test

NAME       READY   STATUS    RESTARTS   AGE     LABELS
pod/dev    1/1     Running   0          2m42s   team=dev
pod/prod   1/1     Running   0          2m32s   team=prod
pod/test   1/1     Running   0          2m18s   team=test


Now lets deploy the replicaset and check it will not acquire the pod which labels team=test because its in the operator NotIN 

kubectl apply -f https://raw.githubusercontent.com/prafulpatel16/kube8-techincalcloud/master/Day%2014/replicaset_web_operator_NotIn.yml

NAME                    READY   STATUS    RESTARTS   AGE     LABELS
pod/dev                 1/1     Running   0          9m17s   team=dev
pod/prafulcloud-clwq7   1/1     Running   0          56s     team=dev
pod/prod                1/1     Running   0          9m7s    team=prod
pod/test                1/1     Running   0          8m53s   team=test
NAME                          DESIRED   CURRENT   READY   AGE   LABELS
replicaset.apps/prafulcloud   3         3         3       57s   <none>


-Now validate the dev and prod pod is acquired by the replicaset 
check the value of the field in the describe pod
Controlled By:  ReplicaSet/prafulcloud

root@master-node-ubnt:~# kubectl describe pod dev
Name:         dev
Namespace:    default
Priority:     0
Node:         node-2/10.128.0.14
Start Time:   Fri, 23 Jul 2021 17:57:35 +0000
Labels:       team=dev
Annotations:  <none>
Status:       Running
IP:           10.36.0.1
IPs:
  IP:           10.36.0.1
Controlled By:  ReplicaSet/prafulcloud
Containers:
  dev:
    Container ID:   docker://821c6ce1d013ccd2e102bdaaa13f503e6853596073e66e097a241f9f31c2fdd5
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:8f335768880da6baf72b70c701002b45f4932acae8d574dedfddaf9
67fc3ac90
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Fri, 23 Jul 2021 17:57:37 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-rvk52 (ro)


      -Now validate the test pod is NOT acquired by the replicaset 
      check the value of the field in the describe pod
      Controlled By: 

root@master-node-ubnt:~# kubectl describe pod test
Name:         test
Namespace:    default
Priority:     0
Node:         node-1/10.128.0.13
Start Time:   Fri, 23 Jul 2021 17:57:59 +0000
Labels:       team=test
Annotations:  <none>
Status:       Running
IP:           10.44.0.2
IPs:
  IP:  10.44.0.2
Containers:
  test:
    Container ID:   docker://f35393302cf2fe1dadbc3362c8ceb699f2bae3d8afde1afb752770e3b1ceed70
    Image:          nginx
    Image ID:       docker-pullable://nginx@sha256:8f335768880da6baf72b70c701002b45f4932acae8d574dedfddaf9
67fc3ac90
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Fri, 23 Jul 2021 17:58:01 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zm6vj (ro)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 

- Now if you delete the replicaset then all the other pods will be deleted which are members of the replicaset but it cannot delete the pods
which are not the member of the pod like team=test pod here.

NAME                    READY   STATUS    RESTARTS   AGE     LABELS
pod/dev                 1/1     Running   0          16m     team=dev
pod/prafulcloud-clwq7   1/1     Running   0          7m48s   team=dev
pod/prod                1/1     Running   0          15m     team=prod
pod/test                1/1     Running   0          15m     team=test
NAME                          DESIRED   CURRENT   READY   AGE     LABELS
replicaset.apps/prafulcloud   3         3         3       7m49s   <none>

kubectl delete -f https://raw.githubusercontent.com/prafulpatel16/kube8-techincalcloud/master/Day%2014/replicaset_web_operator_NotIn.yml

NAME       READY   STATUS        RESTARTS   AGE   LABELS
pod/prod   0/1     Terminating   0          17m   team=prod
pod/test   1/1     Running       0          17m   team=test


team=test pod cannot delete as its not a part of the replicaset member
NAME       READY   STATUS    RESTARTS   AGE   LABELS
pod/test   1/1     Running   0          17m   team=test



